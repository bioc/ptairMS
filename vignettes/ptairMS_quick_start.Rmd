---
title: "ptairMS: Processing and analysis of PTR-TOF-MS data: quick start"
author: "Camille Roquencourt, Paul Zheng, Pierrick Roger and Etienne Thevenot"
package: "`r pkg_ver('ptairMS')`"
vignette: >
  %\VignetteIndexEntry{ptairMS: Processing and analysis of PTR-TOF-MS data, quick Start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteKeywords{MassSpectrometry, Signal processing, PTR-TOF-MS}
output:
  BiocStyle::html_document:
    toc_float: true 
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

```{r setup, message = FALSE, warning = FALSE}
library(ptairMS)
library(ptairData)
```


# Introduction

The _**ptairMS**_ package provides a workflow to process PTR-TOF-MS raw data in the open Hierarchical Data Format 5 ([HDF5](https://www.hdfgroup.org/); .h5 extension), and to generate the peak table as an `ExpressionSet` object for subsequent data analysis with the many methods and packages available in [R](https://www.r-project.org/). 

We present in this vignette a quick handling of this package, and application to two datasets: exhaled breath and mycobacteria culture headspace. For more details on the parameters choice and algorithm, see thptairMS vignette. 

# `ptairData` package

Two real PTR-TOF-MS (Proton Transfert Reaction Time Of Flight) raw data sets are available on the `ptairData` package, from

- exhaled air of two healthy individal, three acquisitions per individual on diffrents day with two exprirations

- mycobateria culture air, two replicates of each two diffrent species and one control (culture medium)

For memory reasons, the mass axis is truncate at the range: [20.4,21.6] U [50 , 150] for human data set, and [20.4 ; 21.6] U [56.4 ; 90.6] for mycobacteria.


# Workflow

![](figures/permanent/ptairMS_workflow.JPG)

To process several files, a `ptrSet` object is first generated with the function `createPtrSet` from the directory containing the raw files, possibly grouped into subfolders according to classes of samples. The object will contain all information about the study: the sample metadata, one peak list for each samples, and several quality metrics about the files. Second, the peak lists are aligned between samples and an `ExpressionSet` (`Biobase` package object) object is returned , containing the peak table, sample metadata, and feature metadata. 

# Exhaled air analysis

## Create a ptrSet object

We start from a directory :
```{r ptairDataExhaled}
dirRaw <- system.file("extdata/exhaledAir", package = "ptairData")
```


```{r createPtrSet}
exhaledSet <- createPtrSet(dirRaw,
                     setName="exhaledSet",
                     mzCalibRef = c(21.022, 60.0525,75.04406),
                     fracMaxTIC = 0.9,
                     saveDir = NULL )
```

This function performs for each files :

- calibration with `mzCalibRef` parameters

- expiration detection, that correspond to the part of Total Ion Chromatogram where the intensity is higher than `fracMaxTIC * max(TIC)` 

- quantify th eprimary ion on the isotope H3(O18)+ 

- provides a default sampleMetadata based on the tree structure of the directory 

A summary plot to check the calibration error and reference calibration peak average shape:  
```{r plotSummary}
plot(exhaledSet)
```

Interactive plot to see Total Ion Spectrum and expirations limits: 
```{r plotTIC}
plotTIC(exhaledSet,showLimits = TRUE,baselineRm = TRUE)
```

An interactive interface to see and change expirations limits :
```{r shinny app, eval=FALSE}
exhaledSet <- changeTimeLimits(exhaledSet)
```

## detecting peak

After creating the ptrSet, we porcess the files with `detectPeak` function. 

For each file in the data set, this function :

- calibrates each expiration and ambiant air

- detects peak in each expiration and ambiant air 

- aligns features between the background and diffrents expirations 

- keeps features present in at least `fracGroup` % of expirations 

- if `normalize=TRUE`, normalizes with the primary ion (devided all features by the quantity of H3(O18)+ *488), and converts in ppb if the ptr reaction information are available in the h5 file (voltage, temperature and pressure of the drift) 

```{r Detect peak}
exhaledSet <- detectPeak(exhaledSet)
```

This function can take few times if there are many files and a large mz range. You can then parallelize the algorithm by set `parallelize = TRUE` and give the number of cores in `nbCores` (the number of files that will be processed simultaneous). To see the number of CPU cores available in your computer, use `parallel::detectCores()`.

## align Samples

Once the files have been all processed, we then align samples (i.e. matching of variables between the peak lists of the samples) with `alignSamples` function. It generate an expressionSet object, that contains the resulting peak table, the sample meta data (from ptrSet) and variable meta data containing the background peak table.

It is possible to apply two filters:

- On the background: only variables with intensities greater than `bgThreshold * background` are kept 

- On samples reproducibility: only variables which are detected in more than $fracGroup$ % of samples are kept.

If you do not want to apply those filters, set `fracGroup` and `bgThreshold` to 0.

```{r Align patient}
eSet <- alignSamples(exhaledSet, group="subfolder", fracGroup = 1, bgThreshold = 4 )
```

## imputation 
To imputue missing values, `ptairMS` returns back to the raw data, and compute with the same method as `detectPeak` the missing values without limit of detection. 
```{r imputation}
eSet <- ptairMS::impute(eSet, exhaledSet)
```

## annotation 
`ptairMS` propose a putative annotation based on the database saved in `'inst/extdata/reference_tables/vocDB_tables`. The function write in the features metadata all possible formulas and names found for each features, and the isotopes for nuclide C13, O17 and O18. 
```{r annotaion}
eSet<-annotateVOC(eSet)
```

## export the expressionSet

You can export the expressionSet with the function `writeEset` into 3 tabulated files 'dataMatrix.tsv', sampleMetadata.tsv', and 'variableMetadata.tsv':

```{r,eval=FALSE}
writeEset(eset, dirC = file.path(getwd(), "processed_dataset"))
```

## Statistical analysis 

You can finally use known package as `ropls` to performs PCA or OPLS analysis.
```{r imageF}
X<-Biobase::exprs(eSet)
SMD<-Biobase::pData(eSet)
features<-Biobase::fData(eSet)
ropls::view(log2(X),printL = FALSE)
```

Delete isotopes:
```{r}
isotope<-Biobase::fData(eSet)[,"isotope"]
X<-X[! (row.names(X)  %in% isotope[!is.na(isotope)]),]
```

```{r}
pca<-ropls::opls(t(log2(X)),crossvalI=5,info.txtC="none",fig.pdfC="none")
plot(pca,type="x-score", parAsColFcVn=SMD$subfolder)

dim1<-ropls::getLoadingMN(pca)[,1]
barplot(sort(abs(dim1),decreasing = TRUE))
knitr::kable(head(features[names(sort(abs(dim1),decreasing = TRUE)),c("vocDB_formula_Hplus","vocDB_name_iupac")]))
```

`plotFeatures` plot for all files the average spectrum baseline corrected of all expirations, and background superimposed as a dashed line. 
 
```{r}
plotFeatures(exhaledSet,mz=67.0539,colorBy="subfolder",typePlot = "ggplot")
plotFeatures(exhaledSet,mz=69.0699,colorBy="subfolder",typePlot = "ggplot")
plotFeatures(exhaledSet,mz=109.066,colorBy="subfolder",typePlot = "ggplot")
plotFeatures(exhaledSet,mz=51.0442,colorBy="subfolder",typePlot = "ggplot")
```


# Mycobacteria: head space analysis

```{r ptairDataBacteria}
dirRaw <- system.file("extdata/mycobacteria", package = "ptairData")
```

```{r createPtrSet2,}
bacteriaSet <- createPtrSet(dirRaw,
                     setName="bacteriaSet",
                     mzCalibRef = c(21.022, 60.0525),
                     fracMaxTIC = 0.7,
                     saveDir = NULL )
```

```{r}
plot(bacteriaSet)
```

```{r}
plotTIC(bacteriaSet,showLimits = TRUE,baselineRm = TRUE)
```

```{r }
bacteriaSet <- detectPeak(bacteriaSet)
```

```{r }
eSet <- alignSamples(bacteriaSet, group="subfolder", fracGroup = 1, bgThreshold = 0 )
```

```{r }
eSet <- ptairMS::impute(eSet,  bacteriaSet)
```

```{r }
eSet<-annotateVOC(eSet)
```

You can know use known package as `ropls` to performs PCA or OPLS analysis.
```{r }
X <- Biobase::exprs(eSet)
SMD <- Biobase::pData(eSet)
features <- Biobase::fData(eSet)
ropls::view(log2(X),printL = FALSE)
```

```{r}
pca<-ropls::opls(t(log2(X)),crossvalI=5,predI=2,info.txtC="none",fig.pdfC="none")
plot(pca,type="x-score",parAsColFcVn=SMD$subfolder,parEllipsesL=FALSE)

dim1<-ropls::getLoadingMN(pca)[,1]
barplot(sort(abs(dim1),decreasing = TRUE))
knitr::kable(head(features[names(sort(abs(dim1),decreasing = TRUE)),c("vocDB_formula_Hplus","vocDB_name_iupac")]))
```


```{r}
plotFeatures(bacteriaSet,mz=63.0299,colorBy="subfolder",typePlot = "ggplot")
plotFeatures(bacteriaSet,mz=77.0607,colorBy="subfolder",typePlot = "ggplot")
plotFeatures(bacteriaSet,mz=87.0795,colorBy="subfolder",typePlot = "ggplot")
```





